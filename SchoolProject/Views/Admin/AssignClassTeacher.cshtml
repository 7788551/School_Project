@{
    ViewData["Title"] = "Assign Class Teacher";
    Layout = "~/Views/Shared/AdminLayout.cshtml";
}

<h4>Assign Class Teacher</h4>

<div class="container mt-4">

    <!-- SESSION -->
    <input type="hidden" id="sessionId" />

    <div class="mb-3">
        <label>Current Academic Session</label>
        <input type="text" id="sessionName" class="form-control" readonly />
    </div>

    <!-- CLASS -->
    <div class="mb-3">
        <label>Class</label>
        <select id="classId" class="form-control" disabled>
            <option value="">Select Class</option>
        </select>
    </div>

    <!-- SECTION -->
    <div class="mb-3">
        <label>Section</label>
        <select id="sectionId" class="form-control" disabled>
            <option value="">Select Section</option>
        </select>
    </div>

    <!-- TEACHER -->
    <div class="mb-3">
        <label>Teacher</label>
        <select id="teacherId" class="form-control">
            <option value="">Select Teacher</option>
        </select>
    </div>

    <button id="btnAssign" class="btn btn-primary">
        Assign / Replace Teacher
    </button>

</div>


@section Scripts {
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            loadCurrentSession();
            document.getElementById('btnAssign')
                .addEventListener('click', saveAssignment);
        });

        // ============================
        // LOAD CURRENT SESSION
        // ============================
        function loadCurrentSession() {
            fetch('/Admin/GetCurrentSession')
                .then(res => res.json())
                .then(data => {

                    if (!data || !data.sessionId) {
                        alert('No active academic session found.');
                        return;
                    }

                    document.getElementById('sessionId').value = data.sessionId;
                    document.getElementById('sessionName').value = data.sessionName;

                    loadClasses(data.sessionId);
                    loadTeachers(data.sessionId);
                });
        }

        // ============================
        // LOAD CLASSES BY SESSION
        // ============================
        function loadClasses(sessionId) {

            fetch(`/Admin/GetClassesBySession?sessionId=${sessionId}`)
                .then(res => res.json())
                .then(data => {

                    const ddl = document.getElementById('classId');
                    ddl.innerHTML = '<option value="">Select Class</option>';
                    ddl.disabled = false;

                    data.forEach(c => {
                        ddl.innerHTML +=
                            `<option value="${c.classId}">${c.className}</option>`;
                    });
                });

            document.getElementById('classId')
                .addEventListener('change', onClassChange);
        }

        // ============================
        // LOAD SECTIONS BY CLASS + SESSION
        // ============================
        function onClassChange() {

            const classId = this.value;
            const sessionId = document.getElementById('sessionId').value;
            const ddl = document.getElementById('sectionId');

            ddl.innerHTML = '<option value="">Select Section</option>';
            ddl.disabled = true;

            if (!classId) return;

            fetch(`/Admin/GetSectionsByClass?sessionId=${sessionId}&classId=${classId}`)
                .then(res => res.json())
                .then(data => {

                    ddl.disabled = false;

                    data.forEach(s => {
                        ddl.innerHTML +=
                            `<option value="${s.sectionId}">${s.sectionName}</option>`;
                    });
                });
        }

        // ============================
        // LOAD TEACHERS BY SESSION
        // ============================
               function loadTeachers() {

            fetch('/Admin/GetTeachersByCurrentSession')
                .then(res => res.json())
                .then(data => {

                    const ddl = document.getElementById('teacherId');
                    ddl.innerHTML = '<option value="">Select Teacher</option>';

                    data.forEach(t => {
                        ddl.innerHTML +=
                            `<option value="${t.teacherId}">${t.teacherName}</option>`;
                    });
                })
                .catch(() => alert('Failed to load teachers.'));
        }

        // ============================
        // SAVE ASSIGNMENT
        // ============================
        function saveAssignment() {

            const payload = {
                ClassId: document.getElementById('classId').value,
                SectionId: document.getElementById('sectionId').value,
                TeacherId: document.getElementById('teacherId').value
            };

            if (!payload.ClassId || !payload.SectionId || !payload.TeacherId) {
                alert('Please select Class, Section, and Teacher.');
                return;
            }

            if (!confirm('Replace existing class teacher for this section?')) return;

            fetch('/Admin/AssignClassTeacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(r => {
                if (r.success) {
                    alert('Class teacher assigned successfully.');
                } else {
                    alert(r.message || 'Assignment failed.');
                }
            });
        }

    </script>
}

