@{
    ViewData["Title"] = "AssignClassTeacher";
    Layout = "~/Views/Shared/AdminLayout.cshtml"; // use your layout
}




<h4>Assign Class Teacher</h4>
<div class="container mt-4">

    <input type="hidden" id="SessionId" />

    <div class="mb-3">
        <label>Session</label>
        <input type="text" id="SessionName" class="form-control" readonly />
    </div>

    <div class="mb-3">
        <label>Class</label>
        <select id="ClassId" class="form-control">
            <option value="">-- Select Class --</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Section</label>
        <select id="SectionId" class="form-control">
            <option value="">-- Select Section --</option>
        </select>
    </div>

    <div class="mb-3">
        <label>Teacher</label>
        <select id="TeacherId" class="form-control">
            <option value="">-- Select Teacher --</option>
        </select>
    </div>

    <button id="btnAssign" class="btn btn-primary">
        Assign
    </button>

</div>





@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            console.log("Assign Class Teacher JS Loaded");

            loadCurrentSession();
            loadTeachers();

            document.getElementById('ClassId').addEventListener('change', function () {
                loadSections();
            });

            document.getElementById('btnAssign').addEventListener('click', saveAssignment);
        });

        // ============================
        // LOAD CURRENT SESSION
        // ============================
        function loadCurrentSession() {
            fetch('/Admin/GetCurrentSession')
                .then(res => res.json())
                .then(data => {
                    if (!data) {
                        alert('No academic session found');
                        return;
                    }

                    document.getElementById('SessionId').value = data.sessionId;
                    document.getElementById('SessionName').value = data.sessionName;

                    loadClasses(data.sessionId);
                })
                .catch(err => console.error(err));
        }

        // ============================
        // LOAD CLASSES
        // ============================
        function loadClasses(sessionId) {
            fetch(`/Admin/GetClassesBySession?sessionId=${sessionId}`)
                .then(res => res.json())
                .then(data => {
                    const ddl = document.getElementById('ClassId');
                    ddl.innerHTML = '<option value="">-- Select Class --</option>';

                    data.forEach(c => {
                        ddl.innerHTML += `<option value="${c.classId}">${c.className}</option>`;
                    });
                });
        }

        // ============================
        // LOAD SECTIONS
        // ============================
        function loadSections() {
            const sessionId = document.getElementById('SessionId').value;
            const classId = document.getElementById('ClassId').value;
            const ddl = document.getElementById('SectionId');

            ddl.innerHTML = '<option value="">-- Select Section --</option>';

            if (!classId) return;

            fetch(`/Admin/GetSectionsByClass?sessionId=${sessionId}&classId=${classId}`)
                .then(res => res.json())
                .then(data => {
                    data.forEach(s => {
                        ddl.innerHTML += `<option value="${s.sectionId}">${s.sectionName}</option>`;
                    });
                });
        }

        // ============================
        // LOAD TEACHERS
        // ============================
        function loadTeachers() {
            fetch('/Admin/GetTeachers')
                .then(res => res.json())
                .then(data => {
                    const ddl = document.getElementById('TeacherId');
                    ddl.innerHTML = '<option value="">-- Select Teacher --</option>';

                    data.forEach(t => {
                        ddl.innerHTML += `<option value="${t.teacherId}">${t.teacherName}</option>`;
                    });
                });
        }

        // ============================
        // SAVE ASSIGNMENT
        // ============================
        function saveAssignment() {

            const payload = {
                SessionId: document.getElementById('SessionId').value,
                ClassId: document.getElementById('ClassId').value,
                SectionId: document.getElementById('SectionId').value,
                TeacherId: document.getElementById('TeacherId').value
            };

            if (!payload.ClassId || !payload.SectionId || !payload.TeacherId) {
                alert('Please select Class, Section and Teacher');
                return;
            }

            fetch('/Admin/AssignClassTeacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    alert('Class Teacher Assigned Successfully');
                } else {
                    alert('Assignment Failed');
                }
            });
        }
    </script>
}
